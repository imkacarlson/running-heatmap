# Running Heatmap Mobile Setup Guide

This guide will help you create a native Android APK of your running heatmap that works entirely offline on your phone.

The process is now handled by a single, interactive script that will guide you through every step, from checking prerequisites to building the final application.

## How It Works

Your existing PC web server remains unchanged. This process creates a separate, native Android app that bundles all your run data locally, allowing it to work without an internet connection.

## Prerequisites

The build script will automatically check for the following. If anything is missing, it will prompt you and offer to install it for you.

*   **Python Packages**: `shapely` and `rtree` for processing run data.
*   **`runs.pkl` file**: The data file generated by `import_runs.py`.
*   **Node.js and npm**: For building the mobile application package.
*   **Java Development Kit (JDK)**: Required for building Android applications.
*   **Android SDK**: The tools for building and packaging the Android app.
*   **Tippecanoe**: Needed for generating PMTiles vector tiles (optional).

If you are on a new system, you can try running the build script, and it will tell you exactly what you need to install. For manual setup, especially on WSL, see the "Manual Environment Setup" section below.

## The Build Process

The entire process is now handled by one script.

1.  **Navigate to the `server` directory:**
    ```bash
    cd server
    ```

2.  **Run the build script:**
    ```bash
    python build_mobile.py [--quick]
    ```

   Run the first build **without** `--quick` so the `mobile/www/data` directory is created.
   Subsequent builds can pass `--quick` to rebuild only the HTML and JavaScript.
   If you want vector tiles bundled for faster map rendering, run `python make_pmtiles.py` beforehand.

The script will then:
1.  ✅ **Check Prerequisites**: Verify that all required tools and files are present.
2.  ✅ **Offer Installations**: If anything is missing, it will ask if you want to install it.
3.  ✅ **Build Web Assets**: Convert your `runs.pkl` data into a mobile-friendly format.
4.  ✅ **Package for Android**: Ask if you want to proceed with building the Android APK.
5.  ✅ **Build the APK**: Create the final `running-heatmap-*.apk` file.

The final APK will be placed in the `mobile/` directory, ready to be installed on your device.

### Optional: PMTiles Vector Tiles

Running `python make_pmtiles.py` (from the `server` directory) will create
`runs.pmtiles` for faster map loading. Execute this after importing new runs and
before building the mobile app if you want the tiles packaged.

## Build and install from WSL (no file copying)

Below is the same workflow **without** the "copy the APK to Windows" detour.
You build inside WSL but call the Windows `adb.exe` directly from WSL using
`wslpath -w`. The APK never leaves Linux.

### 0  One-time Windows host prep

| Step | Action |
| --- | --- |
| **Install platform-tools** | Unzip *platform-tools-latest-windows.zip* to `C:\sdk\platform-tools\`. |
| **Add to PATH** | System Settings → Environment Variables → append that folder to **Path** (or keep the full path handy). |
| **Enable USB debugging on the phone** | Developer Options → USB debugging (+ accept the fingerprint prompt). |
| **Verify** | Open **PowerShell** → `adb devices` ⇒ should show **one** device (`device`, not `unauthorized`). Leave this window open—it keeps the adb **server** running. |

### 1  Make WSL talk to that adb server

Add an alias to your shell startup file:

```bash
alias adb='/mnt/c/sdk/platform-tools/adb.exe'   # adjust the path if you unzipped elsewhere
```

```bash
source ~/.bashrc
adb devices
```

WSL is now a thin client to the Windows adb server—no USB copy tricks needed.

### 2  Build inside WSL

```bash
cd ~/projects/running-heatmap/server
python3 -m venv .venv && source .venv/bin/activate     # first time
pip install -r requirements.txt                        # first time

python import_runs.py      # whenever you add raw files
python make_pmtiles.py     # regenerates runs.pmtiles

python build_mobile.py     # first build (walks you through packaging)
# later edits:
python build_mobile.py --quick    # skips data conversion, just updates HTML/JS
```

The script produces:
`mobile/android/app/build/outputs/apk/debug/app-debug.apk` (Linux path).

### 3  Install the APK directly from WSL

```bash
APK=mobile/android/app/build/outputs/apk/debug/app-debug.apk
adb install -r $(wslpath -w "$APK")       # -r = replace if already installed
```

`wslpath -w` converts the Linux path to `C:\Users\…\app-debug.apk`, which `adb.exe` understands. **No copying, no Explorer, nothing leaves WSL.**

### 4  Hook up Chrome DevTools

```bash
adb reverse tcp:9222 tcp:9222
```

1. Launch **Running Heatmap** on the phone.
2. On Windows Chrome/Edge open **chrome://inspect/#devices** → click **inspect**.

Watch **Console** + **Network** for errors (typical culprits: `runs.pmtiles` 404, `HEAD` not allowed).

### 5  Logcat (optional but handy)

```bash
adb logcat -s chromium AndroidRuntime CapacitorConsole
```

### 6  Fast inner loop

```bash
# WSL
python build_mobile.py --quick
adb install -r $(wslpath -w mobile/android/app/build/outputs/apk/debug/app-debug.apk)
# phone restarts the app; check DevTools console
```

Round-trip ≈ 30 s; no file shuffling.

#### If you ever want hot-reload without reinstalling

```bash
cd mobile
npx cap serve android          # hosts the same files at http://10.0.2.2:3333
adb reverse tcp:3333 tcp:3333   # forward that port
```

The app on the phone will live-reload whenever you edit HTML/JS/CSS in `mobile/www/`.

#### Common pitfalls checklist (unchanged)

* **`HEAD` requests not supported** in Capacitor’s embedded server – remove the probe or use a single GET with a `Range` header.
* **Confirm `runs.pmtiles`** actually landed in `mobile/www/data/` before Gradle runs.
* **Use a relative PMTiles URL**: `pmtiles://data/runs.pmtiles`.
* **Bundle MapLibre & PMTiles JS locally** if you need true offline behaviour.

With this variant the APK never leaves WSL, and every command (build, install, dev-tools forwarding) is executed from the same Linux shell you use to edit the code.



## Updating With New Runs

When you add new runs using the PC version, you can update your mobile app by following these simple steps:

1.  **Import your new runs:**
    ```bash
    cd server
    python import_runs.py
    ```

2.  **Re-run the mobile build script:**
    ```bash
    python build_mobile.py [--quick]
    ```
The script will regenerate the data and build a new APK with your latest runs.

## Uploading Runs on the Device

After installing the APK you can add new activities directly on your phone:

1.  Open the app and tap the **⤴** upload button.
2.  Choose one or more GPX files from your device.
3.  The runs are parsed and stored locally so they remain visible even after restarting the app.

These manually uploaded runs behave the same as your preloaded data—they show up on the map, work with the lasso tool and remain private on your device.

## File Structure

After the build process, your project directory will look like this:

```
running-heatmap/
├── server/              # Your original PC version (unchanged)
│   ├── app.py          # Flask server
│   ├── runs.pkl        # Your run data
│   └── build_mobile.py # NEW: All-in-one mobile build script
├── web/                # Original web interface (unchanged)
└── mobile/             # NEW: Mobile project
    ├── www/            # Web assets for the app
    ├── android/        # Native Android project
    ├── node_modules/   # Dependencies
    └── running-heatmap-*.apk # Your installable app
```

## Manual Environment Setup (for WSL / Linux)

If you prefer to set up your environment manually before running the script:

```bash
# Update package list
sudo apt update

# Install Java Development Kit (required for Android builds)
sudo apt install openjdk-17-jdk

# Install Node.js and npm
sudo apt install nodejs npm

# Install Android SDK command line tools (if not using Android Studio)
# Note: The build script can guide you through this.
# This is a simplified example; paths may vary.
mkdir -p ~/android-sdk
# Download and extract tools from https://developer.android.com/studio

# Set up environment variables (add to ~/.bashrc or ~/.zshrc)
echo 'export ANDROID_HOME=~/android-sdk' >> ~/.bashrc
echo 'export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools' >> ~/.bashrc
source ~/.bashrc

# Accept SDK licenses
yes | sdkmanager --licenses
```

## Security & Privacy

*   ✅ **All data stays local** - no cloud or server is required for the mobile app.
*   ✅ **No tracking** - the app works completely offline after the first load.
*   ✅ **Your runs stay private** - the data never leaves your device.

Enjoy your runs on mobile! 🏃‍♂️📱

# Running Heatmap Mobile Setup Guide

This guide will help you create a native Android APK of your running heatmap that works entirely offline on your phone.

The process is now handled by a single, interactive script that will guide you through every step, from checking prerequisites to building the final application.

## How It Works

Your existing PC web server remains unchanged. This process creates a separate, native Android app that bundles all your run data locally, allowing it to work without an internet connection.

## Prerequisites

The build script will automatically check for the following. If anything is missing, it will prompt you and offer to install it for you.

*   **Python Packages**: `shapely` and `rtree` for processing run data.
*   **`runs.pkl` file**: The data file generated by `import_runs.py`.
*   **Node.js and npm**: For building the mobile application package.
*   **Java Development Kit (JDK)**: Required for building Android applications.
*   **Android SDK**: The tools for building and packaging the Android app.
*   **Tippecanoe**: Needed for generating PMTiles vector tiles (optional).

If you are on a new system, you can try running the build script, and it will tell you exactly what you need to install. For manual setup, especially on WSL, see the "Manual Environment Setup" section below.

## The Build Process

The entire process is now handled by one script.

1.  **Navigate to the `server` directory:**
    ```bash
    cd server
    ```

2.  **Run the build script:**
    ```bash
    python build_mobile.py [--quick]
    ```
   *(Run `python make_pmtiles.py` beforehand if you want vector tiles packaged.)*
   
   Use the `--quick` flag to skip data conversion when you only changed HTML or JavaScript. It reuses the existing `mobile/` directory to speed up the build.

The script will then:
1.  ‚úÖ **Check Prerequisites**: Verify that all required tools and files are present.
2.  ‚úÖ **Offer Installations**: If anything is missing, it will ask if you want to install it.
3.  ‚úÖ **Build Web Assets**: Convert your `runs.pkl` data into a mobile-friendly format.
4.  ‚úÖ **Package for Android**: Ask if you want to proceed with building the Android APK.
5.  ‚úÖ **Build the APK**: Create the final `running-heatmap-*.apk` file.

The final APK will be placed in the `mobile/` directory, ready to be installed on your device.

## Testing in the Browser

Before installing the APK you can quickly verify the mobile build in Chrome.

1. **Run the build script** to generate the web bundle:
   ```bash
   python build_mobile.py [--quick]
   ```
   The output is placed in `../mobile/www/`.
2. **Serve the files locally** (with byte-range support for PMTiles):
   ```bash
   cd ../..  # project root
   python range_http_server.py 8000 -d mobile/www
   ```
   This starts a static server at <http://localhost:8000> that supports HTTP
   range requests used by the PMTiles library.
3. **Open the app in Chrome** at `http://localhost:8000` and use DevTools to
   debug JavaScript, inspect network requests and simulate mobile devices.

Using a local server mirrors how the app loads files from the device. Keep your
paths relative (e.g. `data/runs.json.gz`) so they work from both `http://` and
`file://` locations.

## Installing the APK

Once you have your APK file in the `mobile/` directory:

#### Option 1: Direct Install (with `adb`)
If you have the Android Debug Bridge (`adb`) installed and your phone connected:
```bash
# Make sure you are in the project root directory
adb install mobile/running-heatmap-*.apk
```

#### Option 2: Manual Install
1.  Copy the APK file from the `mobile/` directory to your Android device.
2.  On your device, you may need to enable "Install from unknown sources" in your security settings.
3.  Open a file manager on your device, find the APK file, and tap it to install.

## Updating With New Runs

When you add new runs using the PC version, you can update your mobile app by following these simple steps:

1.  **Import your new runs:**
    ```bash
    cd server
    python import_runs.py
    ```

2.  **Re-run the mobile build script:**
    ```bash
    python build_mobile.py [--quick]
    ```
The script will regenerate the data and build a new APK with your latest runs.

## Uploading Runs on the Device

After installing the APK you can add new activities directly on your phone:

1.  Open the app and tap the **‚§¥** upload button.
2.  Choose one or more GPX files from your device.
3.  The runs are parsed and stored locally so they remain visible even after restarting the app.

These manually uploaded runs behave the same as your preloaded data‚Äîthey show up on the map, work with the lasso tool and remain private on your device.

## File Structure

After the build process, your project directory will look like this:

```
running-heatmap/
‚îú‚îÄ‚îÄ server/              # Your original PC version (unchanged)
‚îÇ   ‚îú‚îÄ‚îÄ app.py          # Flask server
‚îÇ   ‚îú‚îÄ‚îÄ runs.pkl        # Your run data
‚îÇ   ‚îî‚îÄ‚îÄ build_mobile.py # NEW: All-in-one mobile build script
‚îú‚îÄ‚îÄ web/                # Original web interface (unchanged)
‚îî‚îÄ‚îÄ mobile/             # NEW: Mobile project
    ‚îú‚îÄ‚îÄ www/            # Web assets for the app
    ‚îú‚îÄ‚îÄ android/        # Native Android project
    ‚îú‚îÄ‚îÄ node_modules/   # Dependencies
    ‚îî‚îÄ‚îÄ running-heatmap-*.apk # Your installable app
```

## Manual Environment Setup (for WSL / Linux)

If you prefer to set up your environment manually before running the script:

```bash
# Update package list
sudo apt update

# Install Java Development Kit (required for Android builds)
sudo apt install openjdk-17-jdk

# Install Node.js and npm
sudo apt install nodejs npm

# Install Android SDK command line tools (if not using Android Studio)
# Note: The build script can guide you through this.
# This is a simplified example; paths may vary.
mkdir -p ~/android-sdk
# Download and extract tools from https://developer.android.com/studio

# Set up environment variables (add to ~/.bashrc or ~/.zshrc)
echo 'export ANDROID_HOME=~/android-sdk' >> ~/.bashrc
echo 'export PATH=$PATH:$ANDROID_HOME/cmdline-tools/latest/bin:$ANDROID_HOME/platform-tools' >> ~/.bashrc
source ~/.bashrc

# Accept SDK licenses
yes | sdkmanager --licenses
```

## Security & Privacy

*   ‚úÖ **All data stays local** - no cloud or server is required for the mobile app.
*   ‚úÖ **No tracking** - the app works completely offline after the first load.
*   ‚úÖ **Your runs stay private** - the data never leaves your device.

Enjoy your runs on mobile! üèÉ‚Äç‚ôÇÔ∏èüì±

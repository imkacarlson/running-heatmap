<!DOCTYPE html>
<html>

<head>
  <meta charset="utf-8" />
  <title>Run Heatmap</title>
  <script src="https://unpkg.com/maplibre-gl/dist/maplibre-gl.js"></script>
  <link href="https://unpkg.com/maplibre-gl/dist/maplibre-gl.css" rel="stylesheet" />
  <style>
    body,
    html,
    #map {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
    }
  </style>
</head>

<body>
  <div id="map"></div>
  <script>
    // initialize an “empty” style so we can add our own sources/layers
    const map = new maplibregl.Map({
      container: 'map',
      style: {
        version: 8,
        sources: {},
        layers: []
      },
      center: [-98, 39],
      zoom: 4
    });

    map.on('load', () => {
      // 1) Add OSM raster basemap
      map.addSource('osm-tiles', {
        type: 'raster',
        tiles: [
          'https://a.tile.openstreetmap.org/{z}/{x}/{y}.png',
          'https://b.tile.openstreetmap.org/{z}/{x}/{y}.png',
          'https://c.tile.openstreetmap.org/{z}/{x}/{y}.png'
        ],
        tileSize: 256,
        attribution: '© OpenStreetMap contributors'
      });
      map.addLayer({
        id: 'osm-layer',
        type: 'raster',
        source: 'osm-tiles'
      });

      // 2) Add your runs source & heatmap layer
      map.addSource('runs', {
        type: 'geojson',
        data: { type: 'FeatureCollection', features: [] }
      });
      map.addLayer({
        id: 'runs-layer',
        type: 'line',
        source: 'runs',
        paint: {
          'line-color': 'rgba(255,0,0,0.4)',
          'line-width': [
            'interpolate', ['linear'], ['zoom'],
            0, 0.5,   // 0.5px at zoom 0 (nearly invisible zoomed out)
            14, 2     // 2px at zoom 14 (street-width)
          ]
        }
      });

      // 3) Kick off the first fetch of features
      fetchAndUpdate();
    });

    // fetch & update function (expects to be defined in main.js)
    function fetchAndUpdate() {
      const b = map.getBounds();
      const z = Math.floor(map.getZoom());
      const url = `/api/runs?minLat=${b.getSouth()}&minLng=${b.getWest()}&maxLat=${b.getNorth()}&maxLng=${b.getEast()}&zoom=${z}`;
      fetch(url)
        .then(r => r.json())
        .then(data => map.getSource('runs').setData(data));
    }

    // re-fetch on moveend
    map.on('moveend', fetchAndUpdate);
  </script>
</body>

</html>